#!/usr/bin/env nu

const BIN_OFFSET = 3 * 1024

const IMX6_512MB_IVTDCD_TABLE = 0x[
d1 00 20 40 00 00 80 87  00 00 00 00 2c f4 7f 87  20 f4 7f 87 00 f4 7f 87  00 00 00 00 00 00 00 00
00 f0 7f 87 00 00 20 00  00 00 00 00 d2 01 e8 40  cc 01 e4 04 02 0c 40 68  ff ff ff ff 02 0c 40 6c
ff ff ff ff 02 0c 40 70  ff ff ff ff 02 0c 40 74  ff ff ff ff 02 0c 40 78  ff ff ff ff 02 0c 40 7c
ff ff ff ff 02 0c 40 80  ff ff ff ff 02 0e 04 b4  00 0c 00 00 02 0e 04 ac  00 00 00 00 02 0e 02 7c
00 00 00 30 02 0e 02 50  00 00 00 30 02 0e 02 4c  00 00 00 30 02 0e 04 90  00 00 00 30 02 0e 02 88
00 0c 00 30 02 0e 02 70  00 00 00 00 02 0e 02 60  00 00 00 30 02 0e 02 64  00 00 00 30 02 0e 04 a0
00 00 00 30 02 0e 04 94  00 02 00 00 02 0e 02 80  00 00 00 30 02 0e 02 84  00 00 00 30 02 0e 04 b0
00 02 00 00 02 0e 04 98  00 00 00 30 02 0e 04 a4  00 00 00 30 02 0e 02 44  00 00 00 30 02 0e 02 48
00 00 00 30 02 1b 00 1c  00 00 80 00 02 1b 08 00  a1 39 00 03 02 1b 08 0c  00 03 00 0b 02 1b 08 3c
01 48 01 44 02 1b 08 48  40 40 2c 30 02 1b 08 50  40 40 3e 34 02 1b 08 1c  33 33 33 33 02 1b 08 20
33 33 33 33 02 1b 08 2c  f3 33 33 33 02 1b 08 30  f3 33 33 33 02 1b 08 c0  00 94 40 09 02 1b 08 b8
00 00 08 00 02 1b 00 04  00 02 00 2d 02 1b 00 08  1b 33 30 30 02 1b 00 0c  67 6b 52 f3 02 1b 00 10
b6 6d 0b 63 02 1b 00 14  01 ff 00 db 02 1b 00 18  00 20 17 40 02 1b 00 1c  00 00 80 00 02 1b 00 2c
00 00 26 d2 02 1b 00 30  00 6b 10 23 02 1b 00 40  00 00 00 4f 02 1b 00 00  84 18 00 00 02 1b 08 90
00 40 00 00 02 1b 00 1c  02 00 80 32 02 1b 00 1c  00 00 80 33 02 1b 00 1c  00 04 80 31 02 1b 00 1c
15 20 80 30 02 1b 00 1c  04 00 80 40 02 1b 00 20  00 00 08 00 02 1b 08 18  00 00 02 27 02 1b 00 04
00 02 55 2d 02 1b 04 04  00 01 10 06 02 1b 00 1c  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
]

const IMX6_256MB_IVTDCD_TABLE = 0x[
d1 00 20 40 00 00 80 87  00 00 00 00 2c f4 7f 87  20 f4 7f 87 00 f4 7f 87  00 00 00 00 00 00 00 00
00 f0 7f 87 00 60 07 00  00 00 00 00 d2 01 e8 40  cc 01 e4 04 02 0c 40 68  ff ff ff ff 02 0c 40 6c
ff ff ff ff 02 0c 40 70  ff ff ff ff 02 0c 40 74  ff ff ff ff 02 0c 40 78  ff ff ff ff 02 0c 40 7c
ff ff ff ff 02 0c 40 80  ff ff ff ff 02 0e 04 b4  00 0c 00 00 02 0e 04 ac  00 00 00 00 02 0e 02 7c
00 00 00 30 02 0e 02 50  00 00 00 30 02 0e 02 4c  00 00 00 30 02 0e 04 90  00 00 00 30 02 0e 02 88
00 0c 00 30 02 0e 02 70  00 00 00 00 02 0e 02 60  00 00 00 30 02 0e 02 64  00 00 00 30 02 0e 04 a0
00 00 00 30 02 0e 04 94  00 02 00 00 02 0e 02 80  00 00 00 30 02 0e 02 84  00 00 00 30 02 0e 04 b0
00 02 00 00 02 0e 04 98  00 00 00 30 02 0e 04 a4  00 00 00 30 02 0e 02 44  00 00 00 30 02 0e 02 48
00 00 00 30 02 1b 00 1c  00 00 80 00 02 1b 08 00  a1 39 00 03 02 1b 08 0c  00 00 00 04 02 1b 08 3c
01 3c 01 3c 02 1b 08 48  40 40 32 38 02 1b 08 50  40 40 30 28 02 1b 08 1c  33 33 33 33 02 1b 08 20
33 33 33 33 02 1b 08 2c  f3 33 33 33 02 1b 08 30  f3 33 33 33 02 1b 08 c0  00 94 40 09 02 1b 08 b8
00 00 08 00 02 1b 00 04  00 02 00 2d 02 1b 00 08  1b 33 30 30 02 1b 00 0c  3f 43 52 f3 02 1b 00 10
b6 6d 0b 63 02 1b 00 14  01 ff 00 db 02 1b 00 18  00 20 17 40 02 1b 00 1c  00 00 80 00 02 1b 00 2c
00 00 26 d2 02 1b 00 30  00 43 10 23 02 1b 00 40  00 00 00 47 02 1b 00 00  83 18 00 00 02 1b 08 90
00 40 00 00 02 1b 00 1c  02 00 80 32 02 1b 00 1c  00 00 80 33 02 1b 00 1c  00 04 80 31 02 1b 00 1c
15 20 80 30 02 1b 00 1c  04 00 80 40 02 1b 00 20  00 00 08 00 02 1b 08 18  00 00 02 27 02 1b 00 04
00 02 55 2d 02 1b 04 04  00 01 10 06 02 1b 00 1c  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
]

def main [
    --ddr-size: string = '512m', # [possible values: 512m, 256m]
    --cache-dir (-C): path = '',
    bin: path,
    block_dev: path,
] {
    let ivtdcd_table = match $ddr_size {
        '512m' => $IMX6_512MB_IVTDCD_TABLE,
        '256m' => $IMX6_256MB_IVTDCD_TABLE,
        _ => return
    }
    let ivtdcd_table_len = $ivtdcd_table | bytes length

    if $BIN_OFFSET < $ivtdcd_table_len {
        print -e $"BIN_OFFSET=($BIN_OFFSET) is too small"
        return
    }

    let padding_len = $BIN_OFFSET - $ivtdcd_table_len
    let padding = generate 0 {|i|
        if $i < $padding_len {
            {
                out: 0x[00],
                next: ($i + 1),
            }
        }
    }
    | bytes collect

    let binary = open $bin
    let load = bytes build $ivtdcd_table $padding $binary

    if ($load | bytes length) != $BIN_OFFSET + ($binary | bytes length) {
        print -e 'Failed to merge data'
        return
    }

    let imx = (
        $cache_dir
        | path join $"($bin | path parse | get stem).imx"
    )
    $load | save -f $imx

    let confirm = input $"Are you sure burning to ($block_dev)? [Y/n] "
        | str downcase
    if $confirm == 'y' {
        sudo dd iflag=dsync oflag=dsync $"if=($imx)" $"of=($block_dev)" bs=512 seek=2
    }
}
